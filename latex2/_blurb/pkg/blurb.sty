
% https://fr.sharelatex.com/learn/Writing_your_own_class#Preliminary_declarations

% **************************************************
% Identification
% **************************************************
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{blurb}[2017/12/20 Lionel du Peloux]

% **************************************************
% Preliminary declarations
% **************************************************
\RequirePackage{kvoptions}  		% key-value options
\RequirePackage{etoolbox}
\RequirePackage{ifthen}
\RequirePackage{calc}
\RequirePackage{xparse}
\RequirePackage{refcount}
\RequirePackage{lastpage}
\RequirePackage{geometry}			% page layout
\RequirePackage{background}			% add bakground material
\RequirePackage{xcolor}
\RequirePackage{tikz}
\RequirePackage{tikzpagenodes}
\RequirePackage{fancyhdr}

\backgroundsetup{contents={}}
\usetikzlibrary{external,positioning}


% **************************************************
% Declare Options
% **************************************************
\SetupKeyvalOptions{family=blurb,prefix=opt@} 
\DeclareStringOption[]{booksize}[TB_8x10]
\DeclareStringOption[0mm]{top}[0mm]
\DeclareStringOption[0mm]{outer}[0mm]
\DeclareStringOption[0mm]{bottom}[0mm]
\DeclareStringOption[0mm]{inner}[0mm]
\DeclareStringOption[0mm]{binding}[0mm]
\DeclareStringOption[]{pagemodulo}[2]
\DeclareBoolOption[false]{showrules}
\DeclareBoolOption[false]{showframe}
\ProcessKeyvalOptions*

% **************************************************
% Fields
% **************************************************

% paper size
\newlength{\@PaperWidth}				% paper width 
\newlength{\@PaperHeight}				% paper height 

% bleed margins
\newlength{\@BleedInnerMargin}			% inner bleed margin
\newlength{\@BleedOuterMargin}			% outer bleed margin
\newlength{\@BleedBottomMargin}			% bottom bleed margin
\newlength{\@BleedTopMargin}			% top margin bleed margin

% page size
\newlength{\@PageWidth}					% page width without bleed margins (when paper is trimmed)
\newlength{\@PageHeight}				% page height without bleed margins (when paper is trimmed)

% safe content area margins
\newlength{\@SafeContentInnerMargin}	% inner margin of safe content area
\newlength{\@SafeContentOuterMargin}	% outer margin of safe content area
\newlength{\@SafeContentBottomMargin}	% bottom margin of safe content area
\newlength{\@SafeContentTopMargin}		% top margin of safe content area
\newlength{\@SafeContentWidth}			% width of the content body
\newlength{\@SafeContentHeight}			% height of the content body

% content area margin
\newlength{\@ContentTopMargin}			% top margin from the content body
\newlength{\@ContentOuterMargin}		% outer margin from the content body
\newlength{\@ContentBottomMargin}		% bottom margin from the content body
\newlength{\@ContentInnerMargin}		% inner margin from the content body
\newlength{\@ContentBindingOffset}		% additionnal inner margin for the binding
\newlength{\@ContentWidth}				% width of the content body
\newlength{\@ContentHeight}				% height of the content body

%% set default parameters
\setlength{\marginparwidth}{0mm}		% no notes
\setlength{\marginparsep}{0mm}			% no notes
\setlength{\headheight}{14pt}			% increase headheight (default to 12pt)

% get content margins relative to safe area borders
\setlength{\@ContentTopMargin}{\opt@top}
\setlength{\@ContentOuterMargin}{\opt@outer}
\setlength{\@ContentBottomMargin}{\opt@bottom}
\setlength{\@ContentInnerMargin}{\opt@inner}
\setlength{\@ContentBindingOffset}{\opt@binding}

% **************************************************
% Commands
% **************************************************

% \SetBleedMargins{top}{right/outer}{bottom}{left/inner}
\DeclareRobustCommand{\@SetBleedMargins}[4]{
	\setlength{\@BleedTopMargin}{#1}
	\setlength{\@BleedOuterMargin}{#2}
	\setlength{\@BleedBottomMargin}{#3}
	\setlength{\@BleedInnerMargin}{#4}
}

% \SetSafeContentMargins{top}{right/outer}{bottom}{left/inner}
\DeclareRobustCommand{\@SetSafeContentMargins}[4]{
	\setlength{\@SafeContentTopMargin}{#1}
	\setlength{\@SafeContentOuterMargin}{#2}
	\setlength{\@SafeContentBottomMargin}{#3}
	\setlength{\@SafeContentInnerMargin}{#4}
}

% \SetContentMargins{top}{right/outer}{bottom}{left/inner}{binding}
\DeclareRobustCommand{\@SetContentMargins}[5]{
	\setlength{\@ContentTopMargin}{#1}
	\setlength{\@ContentOuterMargin}{#2}
	\setlength{\@ContentBottomMargin}{#3}
	\setlength{\@ContentInnerMargin}{#4}
	\setlength{\@ContentBindingOffset}{#5}
}

% \AddContentMargins{top}{right/outer}{bottom}{left/inner}{binding}
\DeclareRobustCommand{\@AddContentMargins}[5]{
	\setlength{\@ContentTopMargin}{\@ContentTopMargin + #1}
	\setlength{\@ContentOuterMargin}{\@ContentOuterMargin + #2}
	\setlength{\@ContentBottomMargin}{\@ContentBottomMargin + #3}
	\setlength{\@ContentInnerMargin}{\@ContentInnerMargin + #4}
	\setlength{\@ContentBindingOffset}{\@ContentBindingOffset + #5}
}


% --------------------------
% Page layouts
% --------------------------

% \SetStandardPaperLayout{width}{height}
\DeclareRobustCommand{\@SetGenericPageLayout}[2]{

	% paper size
	\setlength{\@PaperWidth}{#1}
	\setlength{\@PaperHeight}{#2}

	% page safe content margins
	\@SetSafeContentMargins{5mm}{5mm}{5mm}{0mm}

	% page bleed margins
	\@SetBleedMargins{0mm}{0mm}{0mm}{0mm}

	% page size
	\setlength{\@PageWidth}{\@PaperWidth-\@BleedInnerMargin-\@BleedOuterMargin}
	\setlength{\@PageHeight}{\@PaperHeight-\@BleedTopMargin-\@BleedBottomMargin}

	% content margins (user-defined content margin + safe content margin)
	\@AddContentMargins{\@SafeContentTopMargin}{\@SafeContentOuterMargin}{\@SafeContentBottomMargin}{0mm}{\@SafeContentInnerMargin}

	% content size
	\setlength{\@ContentWidth}{\@PageWidth - \@ContentBindingOffset - \@ContentInnerMargin - \@ContentOuterMargin}
	\setlength{\@ContentHeight}{\@PageHeight - \@ContentTopMargin - \@ContentBottomMargin}
	
	% current page layout
	\geometry{
		paperwidth=\@PaperWidth,
		paperheight=\@PaperHeight,
		inner=\@ContentInnerMargin+\@BleedInnerMargin,
		outer=\@ContentOuterMargin+\@BleedOuterMargin, 
		bottom=\@ContentBottomMargin+\@BleedBottomMargin,
		top=\@ContentTopMargin+\@BleedTopMargin,
		bindingoffset=\@ContentBindingOffset,
		includeall
		}
}

% \SetBlurbPageLayout{finalwidth}{finalheight}{bleed}{margin}{binding}
\DeclareRobustCommand{\@SetBlurbPageLayout}[5]{

	\newlength{\@BlurbPageWidth}
	\newlength{\@BlurbPageHeight}
	\newlength{\@BlurbBleed}
	\newlength{\@BlurbMargin}
	\newlength{\@BlurbBinding}

	\setlength{\@BlurbPageWidth}{#1}     % page width
	\setlength{\@BlurbPageHeight}{#2}    % page height
	\setlength{\@BlurbBleed}{#3}         % bleed (top, bottom and outside edges)
	\setlength{\@BlurbMargin}{#4}        % inset for margins / safe boundary (top, bottom, outside edges)
	\setlength{\@BlurbBinding}{#5}       % inset for margins / safe boundary (binding edge)

	% page size
	\setlength{\@PageWidth}{\@BlurbPageWidth}
	\setlength{\@PageHeight}{\@BlurbPageHeight}

	% page bleed margins
	\@SetBleedMargins{\@BlurbBleed}{\@BlurbBleed}{\@BlurbBleed}{0mm}

	% paper size
	\setlength{\@PaperWidth}{\@PageWidth + \@BleedInnerMargin + \@BleedOuterMargin}
	\setlength{\@PaperHeight}{\@PageHeight + \@BleedBottomMargin + \@BleedTopMargin}

	% safe content margins
	\@SetSafeContentMargins{\@BlurbMargin}{\@BlurbMargin}{\@BlurbMargin}{\@BlurbBleed+\@BlurbBinding}
	
	% content margins (user-defined content margin + safe content margin)
	\@AddContentMargins{\@SafeContentTopMargin}{\@SafeContentOuterMargin}{\@SafeContentBottomMargin}{\@BlurbBleed+\@ContentBindingOffset}{0mm}

	% binding offset
	\setlength{\@ContentBindingOffset}{\@BlurbBinding}
	
	% content size
	\setlength{\@ContentWidth}{\@PageWidth - \@ContentBindingOffset - \@ContentInnerMargin - \@ContentOuterMargin}
	\setlength{\@ContentHeight}{\@PageHeight - \@ContentTopMargin - \@ContentBottomMargin}

	\geometry{
			paperwidth=\@PaperWidth,
			paperheight=\@PaperHeight,
			inner=\@ContentInnerMargin+\@BleedInnerMargin,
			outer=\@ContentOuterMargin+\@BleedOuterMargin, 
			bottom=\@ContentBottomMargin+\@BleedBottomMargin,
			top=\@ContentTopMargin+\@BleedTopMargin,
			bindingoffset=\@ContentBindingOffset,
			includeall
			}
}

% Display layout rules
\DeclareRobustCommand{\@ShowLayoutRules}{
	\AddEverypageHook{
		\ifthenelse{\isodd{\value{page}}}
		{\backgroundsetup{scale=1.0,angle=0,opacity=1.0,position=current page.center,
			contents={
			\begin{tikzpicture}
				% bleed frame
				\draw [color=red,fill=lightgray,thick] 
				(0,0) rectangle (\@PaperWidth,\@PaperHeight);
				% crop frame
				\draw [color=green,fill=white,thick] 
				(\@BleedInnerMargin,\@BleedBottomMargin) rectangle (\@PaperWidth-\@BleedOuterMargin,\@PaperHeight-\@BleedTopMargin);
				% safe content frame
				\draw [color=blue,thick] 
				(\@BleedInnerMargin+\@SafeContentInnerMargin, \@BleedBottomMargin+\@SafeContentBottomMargin) rectangle (\@PaperWidth-\@BleedOuterMargin-\@SafeContentOuterMargin, \@PaperHeight-\@BleedTopMargin-\@SafeContentTopMargin);
				% binding edge
				\draw[black,thick,dashed] (\@BleedInnerMargin+\@ContentBindingOffset,0) -- (\@BleedInnerMargin+\@ContentBindingOffset,\@PaperHeight);
				% content frame
				\draw [color=cyan,fill=gray!20,fill opacity=0.2, thick] 
				(\@BleedInnerMargin+\@ContentBindingOffset+\@ContentInnerMargin, \@BleedBottomMargin+\@ContentBottomMargin) rectangle (\@ContentBindingOffset+\@ContentInnerMargin+\@ContentWidth,\@BleedBottomMargin+\@ContentBottomMargin+\@ContentHeight);
			\end{tikzpicture}
		}}}
		{\backgroundsetup{scale=1.0,angle=0,opacity=1.0,position=current page.center,
			contents={
			\begin{tikzpicture}
				% bleed frame
				\draw [color=red,fill=lightgray,thick] 
				(0,0) rectangle (\@PaperWidth,\@PaperHeight);
				% crop frame
				\draw [color=green,fill=white,thick] 
				(\@BleedOuterMargin,\@BleedBottomMargin) rectangle (\@PaperWidth-\@BleedInnerMargin,\@PaperHeight-\@BleedTopMargin);
				% safe content frame
				\draw [color=blue,thick] 
				(\@BleedOuterMargin+\@SafeContentOuterMargin, \@BleedBottomMargin+\@SafeContentBottomMargin) rectangle (\@PaperWidth-\@BleedInnerMargin-\@SafeContentInnerMargin, \@PaperHeight-\@BleedTopMargin-\@SafeContentTopMargin);
				% binding edge
				\draw[black,thick,dashed] (\@PaperWidth-\@BleedInnerMargin-\@ContentBindingOffset,0) -- (\@PaperWidth-\@BleedInnerMargin-\@ContentBindingOffset,\@PaperHeight);
				% text frame
				\draw [color=cyan,fill=gray!20,fill opacity=0.2, thick] 
				(\@BleedOuterMargin+\@ContentOuterMargin, \@BleedBottomMargin+\@ContentBottomMargin) rectangle (\@BleedOuterMargin+\@ContentOuterMargin+\@ContentWidth,\@BleedBottomMargin+\@ContentBottomMargin+\@ContentHeight);
			\end{tikzpicture}
		}}}
		\BgMaterial
	}
}



% --------------------------
% Page count multiple of 4
% --------------------------
% Add blank pages to the end of the book so that the total
% number of pages is a multiple of 4 (print constraint)
% help : https://tex.stackexchange.com/a/83498
\patchcmd\mainmatter{\cleardoublepage}
{%
\clearpage\edef\@currentlabel{\number\numexpr\arabic{page}\ifodd\arabic{page}+1\fi\relax}%
\label{LastFrontmatterPage}%
\cleardoublepage
}{}{}

\ExplSyntaxOn
\cs_new:Npn \egreg_int_coremainder:nn #1 #2
 {
  \int_mod:nn { #2 - \int_mod:nn { #1 } { #2 } } { #2 }
}
\NewDocumentCommand{\@PageCountMultipleOfFour} { O{0} }
{
	\prg_replicate:nn
	{
		\egreg_int_coremainder:nn { #1 + \getrefnumber{LastFrontmatterPage} + \getpagerefnumber{LastPage} } { 4 }
	}
	{ \thispagestyle{empty}\null\clearpage }
}
\NewDocumentCommand{\@PageCountMultipleOfTwo} { O{0} }
{
	\prg_replicate:nn
	{
		\egreg_int_coremainder:nn { #1 + \getrefnumber{LastFrontmatterPage} + \getpagerefnumber{LastPage} } { 2 }
	}
	{ \thispagestyle{empty}\null\clearpage }
}
\ExplSyntaxOff


% --------------------------
% Build Layout
% --------------------------
\ifdefempty{\opt@booksize}{
	\@SetGenericPageLayout{210mm}{297mm}
}{
	% Generic Book Size
	\ifdefstring{\opt@booksize}{a4}{
		\@SetGenericPageLayout{210mm}{297mm}
	}{}
	% Blurb Book Size
	\ifdefstring{\opt@booksize}{TB_5x8}{ %Trade Book 5x8 inches
		\@SetBlurbPageLayout{12.700cm}{20.321cm}{0.317cm}{0.635cm}{1.270cm}
	}{}
	\ifdefstring{\opt@booksize}{TB_6x9}{ % Trade Book 6x9 inches
		\@SetBlurbPageLayout{15.240cm}{22.861cm}{0.317cm}{0.635cm}{1.270cm}
	}{}
	\ifdefstring{\opt@booksize}{TB_8x10}{ % Trade Book 8x10 inches
		\@SetBlurbPageLayout{20.320cm}{25.401cm}{0.317cm}{0.635cm}{1.270cm}
	}{}
}
\ifbool{opt@showrules}{\@ShowLayoutRules{}}{}
\ifbool{opt@showframe}{\geometry{showframe}}{}
\ifdefstring{\opt@pagemodulo}{2}{\AtEndDocument{\@PageCountMultipleOfTwo}}{}
\ifdefstring{\opt@pagemodulo}{4}{\AtEndDocument{\@PageCountMultipleOfFour}}{}


