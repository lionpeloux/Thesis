
% Lionel du Peloux (2018)
% https://fr.sharelatex.com/learn/Writing_your_own_class#Preliminary_declarations



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% IDENTIFICATION
%%
%%%%%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{photo}[2017/12/20 Lionel du Peloux]





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% PRELIMINARY DECLARATIONS
%%
%%%%%

\RequirePackage{xkeyval}  			% key-value options for macros
\RequirePackage{etoolbox}
\RequirePackage{ifthen}
\RequirePackage{xstring}
\RequirePackage{calc}
\RequirePackage{xparse}
\RequirePackage{xargs}				% commands with optional arguments
\RequirePackage{refcount}
\RequirePackage{lastpage}
\RequirePackage{xcolor}


\RequirePackage{rotating}
\RequirePackage{adjustbox}
\RequirePackage{graphicx}
\RequirePackage{afterpage}

\RequirePackage{eso-pic}

\RequirePackage{tikz,tikzpagenodes}
\usetikzlibrary{calc,backgrounds,positioning}

% \RequirePackage[strict]{changepage}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% DECLARE OPTIONS
%%
%%%%%

% \SetupKeyvalOptions{family=photo,prefix=opt@} 
% \DeclareStringOption[]{booksize}[TB_8x10]
% \DeclareStringOption[0mm]{top}[0mm]
% \DeclareStringOption[0mm]{outer}[0mm]
% \DeclareStringOption[0mm]{bottom}[0mm]
% \DeclareStringOption[0mm]{inner}[0mm]
% \DeclareStringOption[0mm]{binding}[0mm]
% \DeclareStringOption[2]{pagemodulo}[2]
% \DeclareStringOption[no]{cover}[hard]
% \DeclareStringOption[20mm]{gutter}[20mm]
% \DeclareBoolOption[false]{showrules}
% \DeclareBoolOption[false]{showframe}
% \DeclareBoolOption[false]{showbleed}
% \ProcessKeyvalOptions*





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% PARAMETER FIELDS
%%
%%%%%


\newbool{showanchors}
\booltrue{showanchors}

% display paramteres for anchors (when showanchors=true)
\newlength{\@radius}
% \setlength{\@radius}{0.5mm}
\setlength{\fboxsep}{0pt}
\setlength{\fboxrule}{0.0pt}

% length register
\newlength{\PhotoWidth}
\newlength{\PhotoHeight}
\newlength{\PhotoSkip}
\newlength{\PhotoRefSkip}
\newlength{\PhotoBigSkip}
\newlength{\@TextBoxWidth}
\newlength{\@TextBoxMaxWidth}
\newlength{\@TextBoxXMargin}
\newlength{\@TextBoxYMargin}
\newlength{\@XShift}
\newlength{\@PSXShiftLeft}
\newlength{\@PSXShiftRight}
\newlength{\@YShift}

\setlength{\PhotoRefSkip}{3pt}
\setlength{\PhotoBigSkip}{16pt}
\setlength{\PhotoSkip}{8pt}

\setlength{\@TextBoxWidth}{80mm}
\setlength{\@TextBoxXMargin}{10mm}
\setlength{\@TextBoxYMargin}{0mm}





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% PHOTO SPREAD LAYOUT
%%
%%%%%

% declare keys
\define@key{kvps}{anchor}{\def\@PSAnchor{#1}}
\define@key{kvps}{node}{\def\@PSNode{#1}}
\define@key{kvps}{gopt}{\def\@PSGraphicOptions{#1}}
\define@key{kvps}{xshift}{\def\@PSXShift{#1}}
\define@key{kvps}{yshift}{\def\@PSYShift{#1}}
\define@key{kvps}{lpstyle}{\def\@PSLeftPageStyle{#1}}
\define@key{kvps}{rpstyle}{\def\@PSRightPageStyle{#1}}
\define@key{kvps}{lpcode}{\def\@PSLeftPageCode{#1}}
\define@key{kvps}{rpcode}{\def\@PSRightPageCode{#1}}
\define@key{kvps}{boxcode}{\def\@PSTextBoxCode{#1}}
\define@key{kvps}{boxvpos}{\def\@PSTextBoxPosition{#1}}
% preset keys
\savekeys{kvps}{anchor,node,gopt,xshift,yshift,lpstyle,rpstyle,lpcode,rpcode,boxcode,boxvpos}
\presetkeys{kvps}%
{node={current page.center}, anchor=north west,gopt={width=2\paperwidth},xshift=0cm,yshift=0cm,lpstyle=empty,rpstyle=empty,lpcode={},rpcode={},boxcode={},boxvpos=top}%
{}
% command
\newlength\@MyPSWidth
\newcommand\PhotoSpread[2][]{
	%
	% [#1] : path to image file (mandatory)
	% [#2] : anchor	= north | south
	%		 width 		= image width (default to 2\paperwidth)
	%		 xshift		= image shift along x (0mm)
	%		 yshift		= image shift along y (0mm)
	%		 lpstyle	= fancyhdr left page style (empty)
	%        rpstyle	= fancyhdr right page style (empty)
	%		 lpcode		= code to execute on the left page ({})
	%        rpcode		= code to execute on the right page ({})
	%        boxcode	= code to put in the textbox ({})
	%        boxvpos	= top | bottom
	% 
	% help : https://tex.stackexchange.com/a/23865
	% help : https://tex.stackexchange.com/a/55656
	%

	
	\setkeys{kvps}{#1}{

	% height and width of the image
	\settoheight{\PhotoHeight}{\expandafter\includegraphics\expandafter[\@PSGraphicOptions]{#2}}
	\settowidth{\PhotoWidth}{\expandafter\includegraphics\expandafter[\@PSGraphicOptions]{#2}}

	\global\PhotoHeight=\PhotoHeight
	\global\PhotoWidth=\PhotoWidth
	\global\@MyPSWidth=\PhotoWidth
	% \showthe\@PSXShift
	% correction of half pgflinewidth (Y)
	\IfSubStr{\@PSAnchor}{north}{\setlength{\@YShift}{\@PSYShift+0.5\pgflinewidth}}{}%
	\IfSubStr{\@PSAnchor}{south}{\setlength{\@YShift}{\@PSYShift-0.5\pgflinewidth}}{}%

	% % correction of half pgflinewidth (X)
	\IfSubStr{\@PSAnchor}{west}{%
		\setlength{\@PSXShiftLeft}{\@PSXShift-0.5\pgflinewidth}
		\setlength{\@PSXShiftRight}{\@PSXShift-0.5\pgflinewidth-\paperwidth}
	}{}
	\IfSubStr{\@PSAnchor}{east}{%
		\setlength{\@PSXShiftLeft}{\@PSXShift+0.5\pgflinewidth+\paperwidth}
		\setlength{\@PSXShiftRight}{\@PSXShift+0.5\pgflinewidth}
	}{}
	%
	% make sure length registers get visible  
	% in the scope of \AddToShipoutPictureBG 
	%
	\global\@YShift=\@YShift
	\global\@PSXShiftLeft=\@PSXShiftLeft
	\global\@PSXShiftRight=\@PSXShiftRight
	%
	\IfSubStr{\@PSAnchor}{west}{% normal way from left to right part
		% ==========
		% Left Piece
		% ==========
		%
		% \thispagestyle{\@PSLeftPageStyle}
		% \thispagestyle{empty}
		\AddToShipoutPictureBG*{%
			\begin{tikzpicture}[remember picture, inner sep=0pt]
				\node[anchor=\@PSAnchor, xshift=\@PSXShiftLeft, yshift=\@YShift] at (\@PSNode){
					\expandafter\includegraphics\expandafter[\@PSGraphicOptions]{#2}};
				\coordinate (@Atl) at (current bounding box.north west) {}; % top-left corner
				\coordinate (@Abl) at (current bounding box.south west) {}; % bottom-left corner
				% \draw[line width=0.05mm] (current bounding box.south west) rectangle (current bounding box.north east);
				\path (@Atl -| PGtr) node (@Atr){};  % without bleed
				\path (@Abl -| PGtr) node (@Abr){};  % without bleed
				\path (@Atl -| PPtr) node (@AAtr){}; % with bleed
				\path (@Abl -| PPtr) node (@AAbr){}; % with bleed
				\coordinate (TL) at (@Atl); 	% top-left corner
				\coordinate (BL) at (@Abl); 	% bottom-left corner
				\filldraw[red] (@Atl) circle [radius=\@radius];
				\filldraw[red] (@Abl) circle [radius=\@radius];
				\filldraw[red] (@Atr) circle [radius=\@radius];
				\filldraw[red] (@Abr) circle [radius=\@radius];
				\pgfresetboundingbox
				\path[use as bounding box] (0,0);
			\end{tikzpicture}
			\savenodes{PS}
			\@PSLeftPageCode
		}
		% ==========
		% Right Piece
		% ==========
		\afterpage{%
			% \thispagestyle{\@PSRightPageStyle}
			\AddToShipoutPictureBG*{%
			\begin{tikzpicture}[remember picture, inner sep=0pt]
				\path (@Atl -| PPtl) node (@BBtl){}; % with bleed
				\path (@Abl -| PPtl) node (@BBbl){}; % with bleed
				\path (@Atl -| PGtl) node (@Btl){};  % without bleed
				\path (@Abl -| PGtl) node (@Bbl){};  % without bleed
				\pgfresetboundingbox % required to compute the boundingbox of the picture.
				\node[anchor=north west, xshift=-0.5\pgflinewidth, yshift=0.5\pgflinewidth, inner sep=0pt] at ($(@Btl)+(@Atl)-(@Atr)$) {
					\expandafter\includegraphics\expandafter[\@PSGraphicOptions]{#2}};
				% \draw[line width=0.05mm] (current bounding box.south west) rectangle (current bounding box.north east);
				\coordinate (@Btr) at (current bounding box.north east) {}; % top-left corner
				\coordinate (@Bbr) at (current bounding box.south east) {}; % bottom-left corner
				% store points of interest
				\coordinate (TR) at (@Btr); 	% top-left corner
				\coordinate (BR) at (@Bbr); 	% bottom-left corner
				\filldraw[red] (@Atl) circle [radius=\@radius];
				\filldraw[red] (@Abl) circle [radius=\@radius];
				\filldraw[red] (@Atr) circle [radius=\@radius];
				\filldraw[red] (@Abr) circle [radius=\@radius];
				\filldraw[blue] (@Btl) circle [radius=\@radius];
				\filldraw[blue] (@Bbl) circle [radius=\@radius];
				\filldraw[blue] (@Btr) circle [radius=\@radius];
				\filldraw[blue] (@Bbr) circle [radius=\@radius];
				\pgfresetboundingbox
				\path[use as bounding box] (0,0);
			\end{tikzpicture}
			\savenodes{PS}
			\@PSRightPageCode
		}}
	}{}
	\IfSubStr{\@PSAnchor}{east}{% reverse way
			% more complex ... to be done
	}{}
}}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% PHOTO STANDARD LAYOUT
%%
%%%%%

% declare keys
\define@key{kvpa}{anchor}{\def\@PSAnchor{#1}}
\define@key{kvpa}{node}{\def\@PSNode{#1}}
\define@key{kvpa}{gopt}{\def\@PSGraphicOptions{#1}}
\define@key{kvpa}{xshift}{\def\@PSXShift{#1}}
\define@key{kvpa}{yshift}{\def\@PSYShift{#1}}
% preset keys
\savekeys{kvpa}{node, anchor, gopt, xshift, yshift}
\presetkeys{kvpa}%
{node={current page.center}, anchor=center, gopt={}, xshift=0cm, yshift=0cm}
{}
% command
\newcommand\Photo[2][]{
	%
	% [#1] : path to image file (mandatory)
	% [#2] : node		= tikz coords of photo insertion (current pag.center | (5mm,10mm) ...)
	%		 anchor		= tikz anchor for the photo (eg. north east | south west ...)
	%		 xshift		= image shift along x (0mm)
	%		 yshift		= image shift along y (0mm)
	%		 gopt 		= a list of graphic options passed to includegrapic (eg. {width=3cm} ...)
	% 
	% help : https://tex.stackexchange.com/a/127926/154815
	%
	\setkeys{kvpa}{#1}{
		
		% height and width of the image
		\settoheight{\PhotoHeight}{\expandafter\includegraphics\expandafter[\@PSGraphicOptions]{#2}}
		\settowidth{\PhotoWidth}{\expandafter\includegraphics\expandafter[\@PSGraphicOptions]{#2}}

		\global\PhotoHeight=\PhotoHeight
		\global\PhotoWidth=\PhotoWidth

		% correction of half pgflinewidth (Y)
		\setlength{\@YShift}{\@PSYShift}
		\IfSubStr{\@PSAnchor}{north}{\setlength{\@YShift}{\@PSYShift+0.5\pgflinewidth}}{}%
		\IfSubStr{\@PSAnchor}{south}{\setlength{\@YShift}{\@PSYShift-0.5\pgflinewidth}}{}%

		% correction of half pgflinewidth (X)
		\setlength{\@XShift}{\@PSXShift}
		\IfSubStr{\@PSAnchor}{west}{\setlength{\@XShift}{\@PSXShift-0.5\pgflinewidth}}{}
		\IfSubStr{\@PSAnchor}{east}{\setlength{\@PSXShiftRight}{\@PSXShift+0.5\pgflinewidth}}{}

		% \makebox[0pt][c]{%
		\begin{tikzpicture}[remember picture, inner sep=0pt]
			% \coordinate NL_tl ($ ( A) + (0 ,\a) $);
			\node[anchor=\@PSAnchor, xshift=\@XShift, yshift=\@YShift] 
				at (\@PSNode){%current page.\@PSAnchor
				\expandafter\includegraphics\expandafter[\@PSGraphicOptions]{#2}%
			};
			% store points of interest
			\coordinate (TL) at (current bounding box.north west); 	% top-left corner
			\coordinate (BL) at (current bounding box.south west); 	% bottom-left corner
			\coordinate (TR) at (current bounding box.north east); 	% top-left corner
			\coordinate (BR) at (current bounding box.south east); 	% bottom-left corner
			\coordinate (T) at (current bounding box.north); 		% middle top
			\coordinate (B) at (current bounding box.south); 		% middle bottom
			\coordinate (L) at (current bounding box.west); 		% middle left
			\coordinate (R) at (current bounding box.east); 		% middle right
			% draw points of interest
			\filldraw[red] (TL) circle [radius=\@radius];
			\filldraw[red] (BL) circle [radius=\@radius];
			\filldraw[red] (TR) circle [radius=\@radius];
			\filldraw[red] (BR) circle [radius=\@radius];
			\filldraw[blue] (T) circle [radius=\@radius];
			\filldraw[blue] (B) circle [radius=\@radius];
			\filldraw[blue] (L) circle [radius=\@radius];
			\filldraw[blue] (R) circle [radius=\@radius];
			% reset the bounding box 
			% this is equivalent to the overlay option but it does not 
			% disable the bounding box which is required for computing points of interest
			\pgfresetboundingbox
			\path[use as bounding box] (0,0);
		\end{tikzpicture}
	}
}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% PHOTO CAPTION REF
%%
%%%%%

% declare keys
\define@key{kvpcr}{node}{\def\@PCRNode{#1}}
\define@key{kvpcr}{hrefnode}{\def\@PCRHrefNode{#1}}  % node for hypperlink
\define@key{kvpcr}{anchor}{\def\@PCRAnchor{#1}}
\define@key{kvpcr}{width}{\def\@PCRWidth{#1}}
\define@key{kvpcr}{phantom}{\def\@PCRPhantom{#1}}
\define@key{kvpcr}{xshift}{\def\@PCRXShift{#1}}
\define@key{kvpcr}{yshift}{\def\@PCRYShift{#1}}
% preset keys
\savekeys{kvpcr}{node, anchor, width, xshift, yshift, phantom, hrefnode}
\presetkeys{kvpcr}%
{node=BR, anchor=south west, width=\textwidth/3,xshift=0mm, yshift=0mm, phantom=false, hrefnode={}}%
{}
% command
\newsavebox{\@PCRBox}
\def\@PCRHrefYShift{1em}
\newcommand\PhotoCaptionRef[5][]{
	%
	% [#5] : label 		= caption label
	% [#4] : title 		= caption title/desc
	% [#3] : ltitle 	= caption title for LOF
	% [#2] : type 		= type of captionof (figure, subfigure, ...)
	% [#1] : node		= insertion point as tikz node 
	% 		 hrefnode	= where the phantom caption is positioned on the page 
	%		 anchor		= tikz anchor (eg. north west | south east ...)
	%		 type		= caption type (figure, subfigure, table, subtable, ...)
	%		 label		= label name for xref (eg. fig:name)
	%		 xshift		= image shift along x (0mm)
	%		 yshift		= image shift along y (0mm)
	% 
	\setkeys{kvpcr}{#1}{
		\ifdefempty{\@PCRHrefNode}{\let\@PCRHrefNode\@PCRNode}{}
		\ifstrequal{#2}{figure}{
			\captionsetup[#2]{style=phantom}
		}{
			\captionsetup[#2]{style=phantom,listformat=phantomsub}
		}
		\begin{tikzpicture}[remember picture, inner sep=0pt]
			% phantom caption (opacity = 0) to get ref entries + hyperref target
			\node[anchor=north west, yshift=\@PCRHrefYShift, opacity=0.0] 
				at (\@PCRHrefNode){%
				\ifstrempty{#3}{
					\parbox[t]{\textwidth/3}{\captionof{#2}{#4}\label{#5}}
				}{
					\parbox[t]{\textwidth/3}{\captionof{#2}[#3]{#4}\label{#5}}
				}	
			};
			% put custom output (label + description) to get proper baseline alignment
			\node[anchor=\@PCRAnchor, xshift=\@PCRXShift, yshift=\@PCRYShift, opacity=1.0] 
				at (\@PCRNode){%
					\ifdefstring{\@PCRPhantom}{false}{%
					% \fbox{\parbox[b]{\@PCRWidth}{%
					% 	\IfSubStr{\@PCRAnchor}{east}{\raggedleft}{}%
					% 	\ifstrequal{\@PCRAnchor}{south}{\centering}{}%
					% 	\ifstrequal{\@PCRAnchor}{north}{\centering}{}%
						\IfSubStr{#2}{table}{%
							\ifstrempty{\thesubtable}{%
								\tf@piclabel\thetable%
							}{%
								\tf@piclabel\fbox{\thetable}\fbox{\thesubtable}%
							}%
						}{%
							\ifstrempty{\thesubfigure}{%
								\tf@piclabel\thefigure%
							}{%
								\tf@piclabel\fbox{\thefigure}\fbox{\thesubfigure}%
							}%
						}%
					% }}%
					}{}%
			};
			\coordinate[xshift=\@PCRXShift, yshift=0mm] (A) at (\@PCRNode);
			\filldraw[cyan] (A) circle [radius=\@radius];
			\pgfresetboundingbox
			\path[use as bounding box] (0,0);
		\end{tikzpicture}
	}
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Text Box
%%
%%%%%
\newlength\@TBHeight
\define@key{kvtb}{node}{\def\@TBNode{#1}}
\define@key{kvtb}{anchor}{\def\@TBAnchor{#1}}
\define@key{kvtb}{width}{\def\@TBWidth{#1}}
\define@key{kvtb}{xshift}{\def\@TBXShift{#1}}
\define@key{kvtb}{yshift}{\def\@TBYShift{#1}}
\define@key{kvtb}{border}{\def\@TBHasBorder{#1}}
% preset keys
\savekeys{kvtb}{node, anchor, width, xshift, yshift, border}
\presetkeys{kvtb}%
{node=BR, anchor=south west, width=\textwidth/3, xshift=0mm, yshift=0mm, border=false}%
{}
\newcommand\PhotoTextBox[2][]{
	%
	% [#2] : text 		= caption label for xref
	% [#1] : node		= insertion point as tikz node 
	%		 anchor		= tikz anchor (eg. north west | south east ...)
	%		 xshift		= image shift along x (0mm)
	%		 yshift		= image shift along y (0mm)
	%		 width		= width of the caption parbox (5cm)
	%        align		= left | right | justify
	% 
	\setkeys{kvtb}{#1}{

		% \global\@MyTBWidth=\@TBWidth
		\def\@TBBorderWidth{2pt}
		\ifdefstring{\@TBHasBorder}{false}{\def\@TBBorderShift{0pt}}{\def\@TBBorderShift{2\PhotoRefSkip+\@TBBorderWidth/2}}
		% \showthe\@TBHasBorder
		% \showthe\@TBBorderShift
		\begin{tikzpicture}[remember picture, inner sep=0pt]
			\node[anchor=\@TBAnchor, xshift=\@TBXShift+\@TBBorderShift, yshift=\@TBYShift] 
				at (\@TBNode){%
					\fbox{\parbox[b]{\@TBWidth}{\setstretch{0.95}\tf@fntxt#2}}%	
			};
			% store points of interest
			\coordinate (@TL) at (current bounding box.north west); 	% top-left corner
			\coordinate (@BL) at (current bounding box.south west); 	% bottom-left corner
			\coordinate (@TR) at (current bounding box.north east); 	% top-left corner
			\coordinate (@BR) at (current bounding box.south east); 	% bottom-left corner
			\ifdefstring{\@TBHasBorder}{false}{}{%
				\draw[line width=\@TBBorderWidth] ([xshift=-2\PhotoRefSkip]@TL) -- ([xshift=-2\PhotoRefSkip]@BL);
			}
			\coordinate[xshift=\@TBXShift, yshift=\@TBYShift] (TB) at (\@TBNode);
			% \filldraw[blue] (TB) circle [radius=\@radius];
			\pgfresetboundingbox
			\path[use as bounding box] (0,0);
		\end{tikzpicture}
	}
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% SIMPLE BOX LAYOUT
%%
%%%%%

% declare keys
\define@key{kvsb}{anchor}{\def\@SBAnchor{#1}}
\define@key{kvsb}{node}{\def\@SBNode{#1}}
\define@key{kvsb}{xshift}{\def\@SBXShift{#1}}
\define@key{kvsb}{yshift}{\def\@SBYShift{#1}}
% preset keys
\savekeys{kvsb}{node, anchor, xshift, yshift}
\presetkeys{kvsb}%
{node={current page.center}, anchor=center, xshift=0cm, yshift=0cm}
{}
% command
\newlength{\BoxWidth}
\newlength{\BoxHeight}
\newsavebox{\@tmpbox}
\newcommand\SBox[2][]{
	%
	% [#1] : box content
	% [#2] : node		= tikz coords of photo insertion (current pag.center | (5mm,10mm) ...)
	%		 anchor		= tikz anchor for the photo (eg. north east | south west ...)
	%		 xshift		= image shift along x (0mm)
	%		 yshift		= image shift along y (0mm)
	%		 gopt 		= a list of graphic options passed to includegrapic (eg. {width=3cm} ...)
	% 
	% help : https://tex.stackexchange.com/a/127926/154815
	%
	\setkeys{kvsb}{#1}{
		
		\savebox{\@tmpbox}{#2}

		% height and width of the image
		\settoheight{\BoxHeight}{\usebox{\@tmpbox}}
		\settowidth{\BoxWidth}{\usebox{\@tmpbox}}

		\global\BoxHeight=\BoxHeight
		\global\BoxWidth=\BoxWidth

		% % correction of half pgflinewidth (Y)
		% \setlength{\@YShift}{\@PSYShift}
		% \IfSubStr{\@PSAnchor}{north}{\setlength{\@YShift}{\@PSYShift+0.5\pgflinewidth}}{}%
		% \IfSubStr{\@PSAnchor}{south}{\setlength{\@YShift}{\@PSYShift-0.5\pgflinewidth}}{}%

		% % correction of half pgflinewidth (X)
		% \setlength{\@XShift}{\@PSXShift}
		% \IfSubStr{\@PSAnchor}{west}{\setlength{\@XShift}{\@PSXShift-0.5\pgflinewidth}}{}
		% \IfSubStr{\@PSAnchor}{east}{\setlength{\@PSXShiftRight}{\@PSXShift+0.5\pgflinewidth}}{}

		\begin{tikzpicture}[remember picture, inner sep=0pt]
			\node[anchor=\@SBAnchor, xshift=\@SBXShift, yshift=\@SBYShift] 
				at (\@SBNode){\fbox{\usebox{\@tmpbox}}};
			% store points of interest
			\coordinate (TL) at (current bounding box.north west); 	% top-left corner
			\coordinate (BL) at (current bounding box.south west); 	% bottom-left corner
			\coordinate (TR) at (current bounding box.north east); 	% top-left corner
			\coordinate (BR) at (current bounding box.south east); 	% bottom-left corner
			\coordinate (T) at (current bounding box.north); 		% middle top
			\coordinate (B) at (current bounding box.south); 		% middle bottom
			\coordinate (L) at (current bounding box.west); 		% middle left
			\coordinate (R) at (current bounding box.east); 		% middle right
			% draw points of interest
			\filldraw[red] (TL) circle [radius=\@radius];
			\filldraw[red] (BL) circle [radius=\@radius];
			\filldraw[red] (TR) circle [radius=\@radius];
			\filldraw[red] (BR) circle [radius=\@radius];
			\filldraw[blue] (T) circle [radius=\@radius];
			\filldraw[blue] (B) circle [radius=\@radius];
			\filldraw[blue] (L) circle [radius=\@radius];
			\filldraw[blue] (R) circle [radius=\@radius];
			% reset the bounding box 
			% this is equivalent to the overlay option but it does not 
			% disable the bounding box which is required for computing points of interest
			\pgfresetboundingbox
			\path[use as bounding box] (0,0);
		\end{tikzpicture}
	}
}





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% CAPTION SYMBOLS (arrow, vertical bar, ...)
%%
%%%%%

\newlength{\mkwidth}
\setlength{\mkwidth}{5mm}
\def\mkcolor{\color{Tblue}}
\newcommand{\mk}[2][r]{%	
	\if#1r%
		\fbox{\parbox{\mkwidth}{\mkcolor\raggedright$\blacktriangleright$}}#2
	\fi
	\if#1t%
		\fbox{\parbox{\mkwidth}{\mkcolor\raggedright$\blacktriangle$}}#2
	\fi
	\if#1l%
		\fbox{\parbox{\mkwidth}{\mkcolor\raggedright$\blacktriangleleft$}}#2
	\fi
	\if#1b%
		\fbox{\parbox{\mkwidth}{\mkcolor\raggedright$\blacktriangledown$}}#2
	\fi
}

\def\vsep{\raisebox{0.2ex}{| }}


